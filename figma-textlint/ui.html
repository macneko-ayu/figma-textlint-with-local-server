<h2>Figma TextLint</h2>
<p>
    <label for="file">Token file:</label>
    <input type="file" id="file" name="file">
</p>
<button id="execute">Execute</button>
<button id="cancel">Cancel</button>
<script>
  let token = '';

  const reader = new FileReader();
  const input = document.getElementById('file');
  input.addEventListener('change', () => {
    reader.readAsText(input.files[0], 'UTF-8');
    reader.onload = () => {
      token = reader.result;
    };
  });

  document.getElementById('execute').onclick = () => {
    parent.postMessage({pluginMessage: {type: 'execute'}}, '*');
  }

  document.getElementById('cancel').onclick = () => {
    parent.postMessage({pluginMessage: {type: 'close'}}, '*');
  }

  onmessage = async (event) => {
    if (event.data.pluginMessage.type !== 'send-text') return;

    const textInfos = event.data.pluginMessage.textInfos;
    await Promise.all(textInfos.map(async textInfo => {
      const fileKey = textInfo.fileKey;
      const nodeId = textInfo.nodeId;
      const characters = textInfo.characters;

      const messages = await getTextlintMessages(fileKey, nodeId, characters)
        .catch((e) => {
          alert(e);

        });
      messages.forEach(message => {
        postComment(fileKey, nodeId, message);
      });
    }));
  }

  async function getTextlintMessages(fileKey, nodeId, characters) {
    return new Promise((resolve, reject) => {
      const request = new XMLHttpRequest();
      request.open('POST', 'http://localhost:3000/v1/textlint');
      request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      request.responseType = 'json';
      request.onload = () => {
        if (request.status !== 200) {
          reject(new Error(`${request.status}: ${request.statusText}`));
        } else {
          resolve(request.response.messages);
        }
      };
      request.onerror = () => {
        reject(new Error('Network error'));
      };
      request.send(`text=${characters}`);
    });
  }

  function postComment(fileKey, nodeId, comment) {
    const data = {
      "message": comment,
      "client_meta": {
        "node_id": nodeId,
        "node_offset": {
          "x": 10,
          "y": 10
        }
      }
    }

    const request = new XMLHttpRequest();
    request.open('POST', `https://api.figma.com/v1/files/${fileKey}/comments`);
    request.setRequestHeader('X-FIGMA-TOKEN', token);
    request.setRequestHeader('Content-Type', 'application/json');
    request.onload = () => {
      if (request.status !== 200) {
        alert(`Error ${request.status}: ${request.statusText}`);
      }
    }
    request.onerror = () => {
      alert("Network error")
    };
    request.send(JSON.stringify(data));
  }
</script>
