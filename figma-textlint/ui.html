<h2>Figma TextLint</h2>
<p>
    <label for="file">Token file:</label>
    <input type="file" id="file" name="file">
</p>
<button id="execute">Execute</button>
<button id="cancel">Cancel</button>
<script>
  const reader = new FileReader();
  const input = document.getElementById('file');
  let token = '';

  input.addEventListener('change', () => {
    reader.readAsText(input.files[0], 'UTF-8');
    reader.onload = () => {
      token = reader.result;
    };
  });

  document.getElementById('execute').onclick = () => {
    parent.postMessage({pluginMessage: {type: 'execute'}}, '*');
  }

  document.getElementById('cancel').onclick = () => {
    parent.postMessage({pluginMessage: {type: 'complete'}}, '*');
  }

  onmessage = (event) => {
    if (event.data.pluginMessage.type !== 'send-text') return;

    const fileKey = event.data.pluginMessage.fileKey;
    const nodeId = event.data.pluginMessage.nodeId;
    const characters = event.data.pluginMessage.characters;

    const request = new XMLHttpRequest();
    request.open('POST', 'http://localhost:3000/v1/textlint');
    request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    request.responseType = 'json';
    request.onload = () => {
      const messages = request.response.messages;
      messages.forEach(result => {
        postComment(fileKey, nodeId, result);
      });
    };
    request.send(`text=${characters}`);
  }

  function postComment(fileKey, nodeId, comment) {
    const data = {
      "message": comment,
      "client_meta": {
        "node_id": nodeId,
        "node_offset": {
          "x": 10,
          "y": 10
        }
      }
    }

    const request = new XMLHttpRequest();
    request.open('POST', `https://api.figma.com/v1/files/${fileKey}/comments`);
    request.setRequestHeader('X-FIGMA-TOKEN', token);
    request.setRequestHeader('Content-Type', 'application/json');
    request.onload = () => {
      if (request.status !== 200) {
        console.log(`Error ${request.status}: ${request.statusText}`);
      } else {
        console.log('Complete!');
      }
    }
    request.send(JSON.stringify(data));
  }
</script>
